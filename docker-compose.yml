version: '3.8'

services:
  # Local Ethereum node using Foundry's Anvil
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: shadowdapp-anvil
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --chain-id 31337
      --accounts 10
      --balance 10000
      --block-time 2
      --gas-limit 30000000
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - shadowdapp-network

  # Contract deployer service
  deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: shadowdapp-deployer
    working_dir: /app
    volumes:
      - ./smartcontracts:/app
    environment:
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - RPC_URL=http://anvil:8545
    command: >
      sh -c "
        echo 'Waiting for Anvil to be ready...' &&
        sleep 10 &&
        echo 'Deploying contracts...' &&
        forge script script/DeployPhase1Production.s.sol:DeployPhase1Production \
          --rpc-url http://anvil:8545 \
          --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
          --broadcast \
          -vvv &&
        echo 'Deployment complete!'
      "
    depends_on:
      anvil:
        condition: service_healthy
    networks:
      - shadowdapp-network

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: shadowdapp-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_RPC_URL=http://localhost:8545
      - NEXT_PUBLIC_CHAIN_ID=31337
      - NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID=${WALLET_CONNECT_PROJECT_ID:-}
      # Contract addresses will be set after deployment
      - NEXT_PUBLIC_OICD_TREASURY_ADDRESS=${OICD_TREASURY_ADDRESS:-0x5FbDB2315678afecb367f032d93F642f64180aa3}
      - NEXT_PUBLIC_DARK_POOL_ADDRESS=${DARK_POOL_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
      - NEXT_PUBLIC_FRACTIONAL_RESERVE_ADDRESS=${FRACTIONAL_RESERVE_ADDRESS:-0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0}
      - NEXT_PUBLIC_PRICE_ORACLE_ADDRESS=${PRICE_ORACLE_ADDRESS:-0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9}
      - NEXT_PUBLIC_UNIVERSAL_AMM_ADDRESS=${UNIVERSAL_AMM_ADDRESS:-0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9}
    depends_on:
      - deployer
    networks:
      - shadowdapp-network
    restart: unless-stopped

  # Optional: Relayer service for auto-reveal
  relayer:
    build:
      context: ./relayer
      dockerfile: Dockerfile
    container_name: shadowdapp-relayer
    environment:
      - RPC_URL=http://anvil:8545
      - PRIVATE_KEY=${RELAYER_PRIVATE_KEY:-0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d}
      - DARK_POOL_ADDRESS=${DARK_POOL_ADDRESS:-0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512}
    depends_on:
      - deployer
    networks:
      - shadowdapp-network
    profiles:
      - with-relayer
    restart: unless-stopped

networks:
  shadowdapp-network:
    driver: bridge
    name: shadowdapp-network

volumes:
  anvil-data:
